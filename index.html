<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEEPNEY UPDATED</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
    <style>
        /* --- NEW MARKER STYLES --- */
        .marker-terminal {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white; /* White border to make it pop */
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            cursor: pointer;
            z-index: 10; /* Ensure terminals sit on top of small stops */
        }
        
        .marker-stop {
            width: 10px; /* Smaller scale */
            height: 10px;
            border-radius: 50%;
            border: 1.5px solid white;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
            z-index: 5;
        }

        /* Styles for the Route List card */
        .route-card {
            background: white;
            margin: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background 0.2s;
        }
        .route-card:hover {
            background: #f0f0f0;
        }
        .route-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .route-details {
            font-size: 12px;
            color: #555;
        }
    </style>
</head>
<body>
    <div id="Root">
        <div id="Map_UI_layer">
            <button id="Allroutes"> > </button>
            <div id="Search_Container">
                <input id="Mapinput" type="text" placeholder="Search location..." autocomplete="off">
                <div id="Suggestions_list"></div>
            </div>
        </div>
        
        <div id="Map_layer"></div>
        
        <div id="Routes_layer">
            <h3 style="margin: 10px; color: #333; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 5px;">Available Jeep Routes</h3>
            <div id="Routes_List_Container" style="overflow-y: auto; height: calc(100% - 50px);"></div>
        </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>

    <script>
        // --- 1. CONFIGURATION ---
        // REPLACE WITH YOUR ACTUAL TOKEN
        const ACCESS_TOKEN = 'pk.eyJ1IjoidmFuZXNzYTEwMTEyIiwiYSI6ImNta2FoY2ZzYzF2aTIzZnIyOWdza3RqbWcifQ.ofFcW1pyNuBjqaG1B2LjwA'; 
        mapboxgl.accessToken = ACCESS_TOKEN;

        // --- 2. DATA ---
        // I kept your data structure, but we will "upgrade" the path using the API
        const jeepRoutes = [
            {
                id: 1,
                name: "Bulakan Terminal to Balagtas",
                color: "#FF0000",
                stops: [
                    [120.87604522306077, 14.797289385299596], 
                    [120.88451106809244, 14.812977114112307], 
                    [120.885825, 14.813388697236904],         
                    [120.89719852496195, 14.81807208646916],  
                    [120.885825, 14.813388697236904]          
                ]
            },
            {
                id: 2,
                name: "Balagtas to Bulakan Terminal",
                color: "#00FF00",
                stops: [
                    [120.87697719441377, 14.795355389964158], 
                    [120.88582555379693, 14.813388697236904], 
                    [120.88451106809244, 14.812977114112307], 
                    [120.881006295136, 14.805616011874273],   
                    [120.87939326729115, 14.795202028815105]  
                ]
            },
            {
                id: 3,
                name: "Santa Maria to Pandi",
                color: "#0000FF",
                stops: [
                    [120.9601031451145, 14.821741376892621],  
                    [120.95374006729162, 14.82275659094804],  
                    [120.95739329612721, 14.860787255430091], 
                    [120.95801719612722, 14.863364173221454], 
                    [120.95757576729208, 14.865011620788547]  
                ]
            },
            {
                id: 4,
                name: "Mapulang Lupa to Balagtas",
                color: "#FF00FF",
                stops: [
                    [120.96651838106227, 14.887536127914496], 
                    [120.93978879612719, 14.862987113288161], 
                    [120.93507605195134, 14.863987272712112], 
                    [120.92920028263276, 14.861635684467535], 
                    [120.90620553845629, 14.818098038137249]  
                ]
            },
            {
                id: 5,
                name: "Metrobank Balagtas to Pandi",
                color: "#00FFFF",
                stops: [
                    [120.90552137088271, 14.819485830855873], 
                    [120.8821905961268, 14.821653991688327],  
                    [120.91723488263267, 14.85449093191257],  
                    [120.96661874030346, 14.887459359618925], 
                    [120.96784512496296, 14.907323801744086]  
                ]
            },
            {
                id: 6,
                name: "Cacarong Matanda to Balagtas",
                color: "#FFFF00",
                stops: [
                    [120.96784512496296, 14.907323801744086], 
                    [120.95235743845717, 14.890257914083605], 
                    [120.92916809612728, 14.86155272496997],  
                    [120.90534308078637, 14.848128444486202], 
                    [120.90617335195078, 14.818066922065313]  
                ]
            },
            {
                id: 7,
                name: "Cacarong to Baliwag via Bustos",
                color: "#FF8000",
                stops: [
                    [120.96783116251679, 14.907170502691777], 
                    [120.97920945379823, 14.9184156576699],   
                    [120.9713362588314, 14.9456509747636],    
                    [120.92050099428214, 14.953954313028458], 
                    [120.89718228078775, 14.963435286267357]  
                ]
            },
            {
                id: 8,
                name: "Plaridel Mall to Capitol",
                color: "#800080",
                stops: [
                    [120.86734314200028, 14.886773647201547], 
                    [120.84875703739117, 14.885296932227957], 
                    [120.82115113724038, 14.869445049459658], 
                    [120.81576923466476, 14.856983070715152], 
                    [120.8143724485936, 14.856531968336274]   
                ]
            },
            {
                id: 9,
                name: "Plaridel to San Ildefonso",
                color: "#008080",
                stops: [
                    [120.86733736935493, 14.886793274217546], 
                    [120.86712014452647, 14.89137447965088],  
                    [120.86754163915788, 14.90074418098115],  
                    [120.8732210831171, 14.918402608357866],  
                    [120.8868609378562, 14.955680955615621],  
                    [120.88849685707129, 14.957838457758697], 
                    [120.89032103694966, 14.960240534937066], 
                    [120.89726071051938, 14.96332619254229],  
                    [120.90340189953895, 14.966756739373961], 
                    [120.92770049443799, 14.982974266593242], 
                    [120.93039746954943, 14.997638703004343], 
                    [120.93370825864571, 15.025440786890847], 
                    [120.94129553483234, 15.079379875562154], 
                    [120.9408871691267, 15.103277430062896],  
                    [120.94146977666458, 15.105046444665886]  
                ]
            }
        ];

        // --- 3. MAP SETUP ---
        const map = new mapboxgl.Map({
            container: 'Map_layer',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [120.930815089594, 14.870229270432086],
            zoom: 11
        });

        // --- 4. NEW: FETCH REAL DIRECTIONS ---
        async function getMatchGeometry(coords) {
            // Convert coordinate array to string "lng,lat;lng,lat;..."
            const coordsString = coords.map(c => c.join(',')).join(';');
            
            // Call Directions API with "driving" profile
            // geometries=geojson tells Mapbox to return the actual line shape
            const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coordsString}?geometries=geojson&access_token=${ACCESS_TOKEN}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                // Return the geometry of the first (best) route found
                if (data.routes && data.routes.length > 0) {
                    return data.routes[0].geometry.coordinates;
                }
                return coords; // Fallback to straight line if API fails
            } catch (error) {
                console.error("Error fetching directions:", error);
                return coords; // Fallback
            }
        }

        map.on('load', async () => {
            
            // Loop through routes one by one
            for (const route of jeepRoutes) {
                
                // 1. Fetch the actual road path from Mapbox
                const roadPath = await getMatchGeometry(route.stops);

                // 2. Add Source (The Data)
                map.addSource(`route-${route.id}`, {
                    'type': 'geojson',
                    'data': {
                        'type': 'Feature',
                        'properties': { 'description': route.name },
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': roadPath // Use the fetched road path
                        }
                    }
                });

                // 3. Add Layer (The Visual Line)
                map.addLayer({
                    'id': `layer-${route.id}`,
                    'type': 'line',
                    'source': `route-${route.id}`,
                    'layout': { 'line-join': 'round', 'line-cap': 'round' },
                    'paint': {
                        'line-color': route.color,
                        'line-width': 4,
                        'line-opacity': 0.7
                    }
                });

                // 4. Add Markers (Only for the original stops, not every curve in the road)
                route.stops.forEach((coord, index) => {
                    const el = document.createElement('div');
                    el.style.backgroundColor = route.color;

                    if (index === 0) {
                        // Terminal (Start)
                        el.className = 'marker-terminal';
                        const popup = new mapboxgl.Popup({ offset: 25 })
                            .setHTML(`<b>Terminal:</b><br>${route.name}`);

                        new mapboxgl.Marker(el)
                            .setLngLat(coord)
                            .setPopup(popup)
                            .addTo(map);
                    } else {
                        // Regular Stop
                        el.className = 'marker-stop';
                        new mapboxgl.Marker(el)
                            .setLngLat(coord)
                            .addTo(map);
                    }
                });
            }

            generateRouteList();
        });

        // --- 5. SEARCH LOGIC (Same as before) ---
        const mapInput = document.getElementById('Mapinput');
        const suggestionsList = document.getElementById('Suggestions_list');
        let marker = null; 

        async function getPlaces(query) {
            if (!query) { suggestionsList.style.display = 'none'; return; }
            const center = map.getCenter();
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${ACCESS_TOKEN}&limit=5&country=ph&proximity=${center.lng},${center.lat}&types=poi,address`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                showSuggestions(data.features);
            } catch (err) { console.error(err); }
        }

        function showSuggestions(features) {
            suggestionsList.innerHTML = '';
            if (features.length > 0) {
                suggestionsList.style.display = 'block';
                features.forEach(feature => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerText = feature.place_name;
                    item.addEventListener('click', () => selectLocation(feature));
                    suggestionsList.appendChild(item);
                });
            } else { suggestionsList.style.display = 'none'; }
        }

        function selectLocation(feature) {
            mapInput.value = feature.place_name;
            suggestionsList.style.display = 'none';
            map.flyTo({ center: feature.center, zoom: 15, essential: true });
            if (marker) marker.remove();
            marker = new mapboxgl.Marker().setLngLat(feature.center).addTo(map);
        }

        let timeoutId;
        mapInput.addEventListener('input', (e) => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => getPlaces(e.target.value), 300);
        });

        document.addEventListener('click', (e) => {
            if (!document.getElementById('Search_Container').contains(e.target)) {
                suggestionsList.style.display = 'none';
            }
        });

        // --- 6. UI TOGGLE & ROUTE LIST (Updated to zoom to road path) ---
        const allRoutesBtn = document.getElementById('Allroutes');
        const routesLayer = document.getElementById('Routes_layer');
        const routesListContainer = document.getElementById('Routes_List_Container');

        allRoutesBtn.addEventListener('click', () => {
            if (window.getComputedStyle(routesLayer).display === 'none') {
                routesLayer.style.display = 'block';
                allRoutesBtn.innerText = "<";
            } else {
                routesLayer.style.display = 'none';
                allRoutesBtn.innerText = ">";
            }
        });

        function generateRouteList() {
            routesListContainer.innerHTML = '';
            jeepRoutes.forEach(route => {
                const card = document.createElement('div');
                card.className = 'route-card';
                card.innerHTML = `
                    <div class="route-title" style="color: ${route.color}">${route.name}</div>
                    <div class="route-details">Stops: ${route.stops.length}</div>
                `;
                
                // When clicking card, zoom to the WHOLE route (all stops)
                card.addEventListener('click', () => {
                    const bounds = new mapboxgl.LngLatBounds();
                    route.stops.forEach(coord => bounds.extend(coord));
                    map.fitBounds(bounds, { padding: 100, duration: 2000 });
                });

                routesListContainer.appendChild(card);
            });
        }
    </script>
</body>
</html>